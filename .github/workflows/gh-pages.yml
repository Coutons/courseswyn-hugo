# .github/workflows/gh-pages.yml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.128.0'  # Minimum version required by Clarity theme
          extended: true

      - name: Install Dependencies
        run: |
          # Install Node.js dependencies
          echo "Installing global dependencies..."
          npm install -g postcss postcss-cli autoprefixer postcss-import
          
          # Clean up existing theme directory
          echo "Setting up theme..."
          rm -rf themes/clarity
          
          # Clone theme
          echo "Cloning Clarity theme..."
          git clone --depth 1 https://github.com/chipzoller/hugo-clarity.git themes/clarity
          
          # Install theme dependencies
          if [ -f "themes/clarity/package.json" ]; then
            echo "Installing theme dependencies..."
            cd themes/clarity
            npm ci
            cd ../..
          else
            echo "Warning: No package.json found in theme directory"
          fi

      - name: Build
        run: |
          # Show environment info
          echo "=== Environment Info ==="
          hugo version
          node --version
          npm --version
          
          # Show theme info
          echo -e "\n=== Theme Info ==="
          ls -la themes/clarity/
          
          # Show Hugo configuration
          echo -e "\n=== Hugo Configuration ==="
          hugo config
          
          # Build the site with detailed output
          echo -e "\n=== Building Site ==="
          rm -rf public/
          
          # First build with debug info
          echo -e "\n--- Initial Build ---"
          hugo --minify --gc --cleanDestinationDir --environment production --logLevel debug || true
          
          # If first build fails, try with more detailed output
          if [ ! -d "public" ] || [ -z "$(ls -A public/)" ]; then
            echo -e "\n--- Build Failed, Retrying with More Verbose Output ---"
            rm -rf public/
            HUGO_ENABLEGITINFO=true \
            hugo --minify --gc --cleanDestinationDir --environment production --logLevel debug --verbose || true
          fi
          
          # Verify build output
          echo -e "\n=== Build Output ==="
          if [ -d "public" ]; then
            echo "Build directory size:"
            du -sh public/
            
            echo -e "\nFirst 10 files in public/:"
            find public/ -type f | head -n 10 || echo "No files found in public/"
            
            echo -e "\nChecking for index.html..."
            find public/ -name "index.html" | head -n 5 || echo "No index.html found"
          else
            echo "ERROR: Build failed - public/ directory not created"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'public'
          branch: 'gh-pages'
          clean: true
          clean-exclude: |
            .nojekyll
            CNAME
            .gitignore
          commit-message: 'Deploy to GitHub Pages: ${{ github.sha }}'